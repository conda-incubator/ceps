<table>
<tr><td> Title </td><td> Technical specification for creation and deletion of conda environments </td>
<tr><td> Status </td><td> Draft </td></tr>
<tr><td> Author(s) </td><td> Jaime Rodríguez-Guerra &lt;jrodriguez@quansight.com&gt;</td></tr>
<tr><td> Created </td><td> Jun 10, 2022</td></tr>
<tr><td> Updated </td><td> Jun 10, 2022</td></tr>
<tr><td> Discussion </td><td> NA </td></tr>
<tr><td> Implementation </td><td> NA </td></tr>
</table>

## Abstract

Conda environments have existed for more than 10 years. During most of that time,
`conda` was the only tool available to create, modify and delete conda environments. As a result,
once the Python implementation was considered stable enough, its integration test suite could be
regarded as the only technical specification needed for practical purposes.

However, as other tools appeared in the ecosystem (namely `mamba` and `micromamba`, along with the
`libmamba`-based solver), some of the tests contained in the integration suite did not adjust to
the ecosystem expectations (tests too strict, too tied to `conda` implementation details,
ambiguous results, conflicting outcomes across different tests, etc).

In this CEP, we'd like to propose a minimum set of guidelines any software implementation that
operates on `conda` environments should adhere to.

## Specification

The technical specification will list a set of cases where known input conditions are given, and
list the expected outcome and its rationale. It will be detailed at the command-line interface
level following conda's 4.13 implementation. However, this CEP will not try to standardize the CLI
commands, subcommands or flags. That work can be discussed in a different CEP.

### Terminology

#### Conda environment

The [conda docs][conda-docs-environments] define a `conda` environment as a "a directory that
contains a specific collection of conda packages that you have installed". However, the internal
structure of that directory is not fully specified, since it depends on the contents of the
packages installed.

The only technical requirement enforced by `conda` activation mechanisms is that the environment
must contain a `conda-meta` directory with a `history` file. Other than that, the environment can
contain anything. It must be noted, though, that there are other important locations which might be
present in the directory tree. These are optional, but have a role in the conda environment
lifecycle:

- `bin/`: added to PATH on Unix
- `lib/`: searched for dynamic libraries on Unix
- `Scripts/`, `Library/bin`: added to PATH on Windows
- `etc/conda/activate.d`, `etc/conda/deactivate.d`: searched for activation and deactivation
  scripts, respectively

#### Package record

Also known as a repodata record. A collection of metadata that refer to a concrete and specific
instance of a package artifact, usually a `.tar.bz2` or a `.conda` file. The conda channels list
package records in their `repodata.json` files. Check the [repodata record schema][repodata-record]
and the [`PackageRecord` classes][packagerecord] for more details.

#### Match specification

Also known as _match spec_. A domain-specific language to query conda channels for one or more
package records. There's no implementation agnostic specification available, so the best resource
so far is [conda's `MatchSpec` class][matchspec-class].

#### Environment file

A YAML file that defines a list of match specs that will be used to create or update a conda
environment. It can optionally list channels and the name of the environment to be created.
Interestingly, it also supports some `pip` interfacing: the file can detail which PyPI packages
should be installed in the environment too.

#### Lock file

A file that defines a list of package records so a conda environment can be created
deterministically, without using match specs (which requires invoking a solver). There are two types
of lock files in the conda ecosystem:

- Unified lock file: A YAML file generated by conda-lock, with multi-platform support.
- Explicit lock file: Legacy format that employs a TXT file to list packages via their URLs and
  hashes. It can only express the requirements for a single platform.

#### History file

A plain-text file with a diff-like syntax that collects the match specifications used to modify
a conda environment during its lifetime. It's always located under `conda-meta/history`.

#### Pinning

Conda environments can mark some of the installed packages as "pinned", meaning that their version
changes are constrained in some way. To do so, a plain text file can list the packages and their
restraints in a `conda-meta/pinned` file. Pinnings can be overriden under certain circumstances.

### Creation of conda environments

### Deletion of conda environments

## References



## Copyright

All CEPs are explicitly [CC0 1.0 Universal](https://creativecommons.org/publicdomain/zero/1.0/).

[conda-docs-environments]: https://docs.conda.io/projects/conda/en/latest/user-guide/concepts/environments.html
[repodata-record]: https://github.com/conda/schemas/blob/master/repodata-record-1.schema.json
[packagerecord]: https://github.com/conda/conda/blob/4.13.0/conda/models/records.py
[matchspec-class]: https://github.com/conda/conda/blob/4.13.0/conda/models/match_spec.py#L69